# LiveSplit MultiNameSplits 技術仕様書

**最終更新**: 2025/06/18時点

## フォークについて

- **フォーク元**: LiveSplit.Subsplits
- **互換性**: Splitsの機能は全て使える
  - 昔はそうでなかった影響で、このあたりの仕様を雑にAIに質問すると、頓珍漢な返答をくれるので注意
- **開始コミット**: ba1dc4b
  - https://github.com/LiveSplit/LiveSplit.Subsplits/commit/ba1dc4b90ae42fc1b038174d41ce79a0f5c1ae31
- **アプリ対応**: フォーク時点の最新版（1.8.33）までに取り込まれてる

## 開発要件
- .NET Framework: 4.8.1

## 対応バージョン（テスト対象バージョン）
- 1.8.33（現時点の最新版）
- 1.8.30（.NET Framework 4.8.1対応になった最初のバージョン）

## インストール方法

- GitHubのReleaseページにdllファイルを設置し、それをDLしてもらう
  - https://github.com/a-ki-yoshi/LiveSplit.MultiNameSplits/releases
- あとは通常のLiveSplitコンポーネントと同じ

## 3つの機能

### [1] Multi Name Splits機能

**概要**: 本コンポーネントのメイン機能
**機能**: スプリット名を一定時間ごとに自動で切り替えることができる

#### できること、用途の例
- スプリット名を母国語と外国語で交互に表示する
- スプリット名と、区間に関する小規模な説明文を表示したりなど

#### レイアウトエディター設定

**表示場所**
- 「Multi Split Names」 
- 「Split Names」 の下

**設定項目**

##### Separator Text 区切り文字
- **デフォルト値**: "/"
- **入力可能文字**: 任意の文字（複数文字可）
- **制限**:
  - 禁止文字: `-` `{` `}` （Subsplits機能で使用するため）
  - 絵文字: 使用可能（推奨はしていない）
- **動作**:
  - 空文字の場合: 名前の切り替えを行わず、スプリット名をそのまま表示
  - スプリット名に含まれない文字の場合: スプリット名をそのまま表示
  - 空白文字とトリミング:
    - "/" にした場合: `"  aaa  / bbb"` → `"aaa"` と `"bbb"` （前後のスペースはトリミング）
    - " / " にした場合: `"aaa/bbb"` では区切られない
  - 全角文字の自動半角変換:
    - a~z A~Z 0~9 記号 スペース に対応（カタカナは非対応）
    - "／/" と入力した場合 → "//" に変換
    - "aaa／bbb" で区切り文字が "/" の場合 → "aaa" と "bbb" に分割
- **エラー処理**:
  - 禁止文字入力時: 即座に自動消去、注意メッセージを表示
    - "{/" などのように禁止文字の後ろに有効な文字を付与した文字列をコピペなどすると表示しないが、今のところ対応なし
  - 注意メッセージ: 入力欄の右側に表示、フォーカスが外れるか正常文字で編集時に非表示

##### Display Time (Seconds) 
- **説明**: 次の名前に切り替えるまで表示する時間（スプリット名の表示が一巡するまでの総時間ではない）
- **デフォルト値**: 2
- **範囲**: 1 ~ 999999秒
- **単位**: 秒
- **操作**: 矢印ボタンは1秒刻み

##### Transition Time (Seconds) 
- **説明**: 切り替わり時の演出時間（フェードイン開始からフェードアウト終了まで）
- **デフォルト値**: 1.0
- **範囲**: 0.1 ~ 999.0秒
- **単位**: 秒
- **例**: 2秒設定の場合、フェードアウトとフェードインが1秒ずつ
- **操作**: 矢印ボタンは0.1秒刻み
- **注意**: Display Timeの1/2より大きな値の場合、フェードインとフェードアウトのタイミングが重複し、不思議な表示になる（禁止はしていないが注意メッセージを表示）
- **備考**: "Fade Time" がふさわしい名称だが、今後トランジションの種類を増やす可能性があるため現在の名称を使用

##### Details
- **概要**: 区切り文字で分割された各テキスト部分に対して、個別に表示設定を行う機能
- **用途**: スプリット名の各部分を異なる色・フォント・表示時間で表示したい場合に使用
- **備考**: 
  - 初期表示時や設定変更時に区切りの最大数を自動で計算して、その数だけ個別設定欄を表示する
  - Separator Textにて設定された文字列がどのスプリット名にも存在しない場合は、表示されない

###### Show
- **説明**: 表示・非表示を切り替える。チェックなしの場合は、下記の "Display Time" "Color and Font" を設定不可にする
- **デフォルト値**: true（チェックあり）
- **例**: 2番目の区切りがチェックなしの場合は、各スプリット名の2番目のテキスト表示がスキップされる
- **注意**: 
  - 全ての項目を非表示にはできない。チェックありが1つのみの場合は、チェックを切り替えられないようにクリック不可になる
  - スプリットによって区切られた数が異なる場合は、チェックの外し方によっては文字列が表示されないことがある（エラーにはならない）
  - この場合、表示される区切りのみがDetails設定に従って動作する

##### Display Time
- **説明**: "Display Time (Seconds) " と同じく、次の名前に切り替えるまで表示する時間
- **デフォルト値**: "Display Time (Seconds)" と同値
- **範囲**: 1 ~ 999999秒
- **単位**: 秒
- **操作**: 矢印ボタンは1秒刻み
- **注意**: 
  - 一度デフォルト値と異なる値に設定すると、Resetしない限り、"Display Time (Seconds) " を変更しても連動されない

##### Color and Font (Color)
- **説明**: テキストの色を変更できる
- **デフォルト値**: 他の箇所で設定された色 (設定ダイアログを開いた際は黒。RGBA 0, 0, 0, 255)
- **制限**: なし
- **注意**: 
  - 設定した場合は、"Subsplits" や "Split Names" などの箇所にてテキストの色を設定していても、上書きされる
  - 一度設定すると、Resetしない限り、他の箇所での設定は反映されない
  - スプリットによって区切りの数が異なる場合、フェードなしで急に色が切り替わる

##### Color and Font (Font)
- **説明**: テキストのフォントを変更できる
- **デフォルト値**: "Layout" タブにて設定されたフォント (設定ダイアログを開いた際は Segoe UI 16)
- **制限**: なし
- **注意**: 
  - フォント名が長すぎる場合、ボタンに表示される名前が途中で途切れる
  - 一度設定すると、Resetしない限り、"Layout" タブでの設定は反映されない

##### Move (Up・Down)
- **説明**: 項目の設定の順番を変更できる
- **動作**: １回のクリックにつき1行分の変更
- **制限**: 最上位・最下位の項目はそれぞれUp・Downボタンが無効化される
- **効果**: 順番を変更しても、スプリット名の各部分の表示順序は変わらない

##### Reset
- **説明**: 項目の設定を初期化し、デフォルト値に戻す
- **対象**: Show、Display Time、Color and Fontの全ての設定
- **注意**: 一度Resetすると、他の箇所での設定変更が再び反映されるようになる

#### スプリット名によって区切り文字が含まれる回数が異なる場合

**例**: スプリット名が `"aaa/bbb/ccc"` と `"ddd/eee"` `"fff"` の3つあり、区切り文字が "/" の場合

1. "aaa" と "ddd" がフェードインする
2. "aaa" と "ddd" がフェードアウトする
3. "bbb" と "eee" がフェードインする
4. "bbb" のみフェードアウトする。"eee" はそのまま表示し続ける
5. "ccc" がフェードインする。"eee" はそのまま表示し続ける
6. "ccc" と "eee" が共にフェードアウトする
7. "aaa" と "ccc" がフェードインし、最初に戻る
8. その間どのタイミングでも、"fff" は、フェードインもフェードアウトもせず表示され続ける

#### その他
- スプリット名のテキスト、影、アウトラインや背景についても考慮済み。不透明度が255未満であっても違和感なくフェードするようにしている

### [2] 初期設定の自動インポート機能

**概要**: 
コンポーネント追加時、既に "Multi Name Splits" "Subsplits" "Splits" のいずれかが追加されている場合は、その設定を初期設定に反映

**優先順位**:
- 複数種類が存在する場合は、上記の優先順で1つのみ採用
  - 例: "Splits"、 "Subsplits" "Multi Name Splits" がすでに存在する場合、 "Multi Name Splits" の設定を初期設定にする
  - インポート元に存在しない設定はデフォルト値となる
    - 例: "Splits" コンポーネントを対象とした場合はSubsplits関連の設定は存在しないので、そのあたりはデフォルト値となる
- 同種のコンポーネントが複数種類が存在する場合は、上にある方を優先して1つのみ採用
  - 例: "Splits"、 "Subsplits"(1つ目) "Subsplits"(2つ目) がすでに存在する場合、 "Subsplits" の1つ目の設定を初期設定にする
- "Subsplits"コンポーネントなどを削除した上でコンポーネント追加した場合は、インポートされずデフォルト値が設定される
- インポート元の対象となるコンポーネントは3種のみ。他は"Splits" などからフォークされたコンポーネントであっても対象とならない
  - 対象にしちゃったら、なんかあったときこわいもん……

**設定項目**: レイアウトエディターには、その機能自体に関する設定項目はなし
- インポートボタンつけた方が親切かもしれないけど、需要少なそうなので少なくとも1.0.0には実装しない

### [3] SubsplitsのON/OFF 機能

**概要**: 無効化すると、（[1]の機能によりスプリット名の自動切り替え表示が行われる以外は）Splitsコンポーネントと同様の表示になる

**目的**: スプリット名の書き方などによってはSplits機能のみ有効化してほしい人もいるかと思い、機能追加

**レイアウトエディター**:
- "Subsplits" のグループの一番上に "Enable Subsplits" のチェックボックスを追加
- **デフォルト値**: 
  - [2] でインポート元が "Splits" の場合はfalse
  - [2] でインポート元が "Multi Name Splits" かつ、そのコンポーネントでの設定がfalseの場合はfalse
  - それ以外はtrue

## こっそり修正

- レイアウトエディターが見づらかったので、グループ名ラベルを太文字にして色を付けた
- レイアウトエディターのColumnsの各項目が下マージンなくてそわそわしたのでこっそり足した

## トラブルシューティング

### よくある問題と解決方法

#### 区切り文字が機能しない
**原因**: スプリット名に区切り文字が含まれていない、または禁止文字を使用している
**解決方法**: 
- スプリット名に区切り文字が含まれているか確認
- 禁止文字（`-` `{` `}`）を使用していないか確認
- 全角文字を使用している場合は半角に変換されることを確認

#### 名前の切り替えが表示されない
**原因**: Transition Timeが長すぎる説
**解決方法**:
- Transition Timeを短くする（推奨: Display Timeの1/2以下）

#### フェードイン・フェードアウトが重複して表示がおかしい
**原因**: Transition TimeがDisplay Timeの1/2より大きい
**解決方法**: Transition TimeをDisplay Timeの1/2以下に設定

#### 初期設定がインポートされない
**原因**: 対象コンポーネントが存在しない、または削除されている
**解決方法**:
- 既存の "Multi Name Splits" "Subsplits" "Splits" コンポーネントが存在するか確認
- 事前にコンポーネントを削除してしまった場合は、まだレイアウトファイルを保存していない場合は、
  1. 一旦レイアウトを保存せずに別のレイアウトを開く
  2. コンポーネントを追加したいレイアウトを開きなおす

#### 全角文字が正しく半角に変換されない
**原因**: カタカナは自動変換に対応していない仕様。それ以外は考慮漏れの恐れあり
**解決方法**: 手動で半角文字に変更する、あと考慮漏れの可能性の場合は是非とも私にご連絡ください

#### 全角文字を半角に変換してほしくない
**状況**: すみません、表記ゆれによるトラブルを避けるほうを優先しました。現状解決手段がありません
**対応**: もしよろしければ、できれば全角が良い理由を添えて、私にご連絡ください。連絡先はREADME.mdに書いてあります

### デバッグ方法

#### デバッグログの確認
- **開発者向け**: Visual Studioの出力ウィンドウでデバッグメッセージを確認
- **ログ形式**: `"[MultiNameSplits] メッセージ内容"`
- **主なログ**:
  - 設定読み込みエラー: `"Error getting settings: [エラー内容]"`
  - インデックスエラー: `"Invalid SplitNameIndex: [インデックス], Array length: [配列長]"`

#### 設定項目の確認
- レイアウトエディターで各設定項目の値を確認
- 注意メッセージが表示されている場合は内容を確認

#### 動作確認
- スプリット名の分割結果を確認
- フェードイン・フェードアウトのタイミングを確認
- 設定変更後の動作を確認

#### パフォーマンス
- 大量のスプリットがある場合、メモリ使用量が増加する可能性
- キャッシュ機能により、初回読み込み後の動作は高速化される

#### 文字変換
- 全角→半角変換は一部の文字のみ対応（a~z, A~Z, 記号, スペース）
- カタカナや一部の特殊文字は変換されない

#### 設定の互換性
- 元のSubsplitsコンポーネントとの完全な互換性は保証されない
- 一部の設定項目は独自の実装になっている